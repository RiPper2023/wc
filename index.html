<html><head><base href="https://dissaladillo.online/wp-json/wc/v3/">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    color: #333;
    line-height: 1.6;
    padding: 20px;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    position: relative;
  }
  h1, h2 {
    color: #2c3e50;
  }
  .warning {
    background-color: #f39c12;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  .numbered-block {
    position: relative;
    margin-bottom: 20px;
  }
  .collapsible {
    background-color: #f1f1f1;
    color: #444;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 15px;
  }
  .active, .collapsible:hover {
    background-color: #ccc;
  }
  .content {
    padding: 0 18px;
    display: none;
    overflow: hidden;
    background-color: #f1f1f1;
  }
  .collapsible:after {
    content: '\002B';
    color: #777;
    font-weight: bold;
    float: right;
    margin-left: 5px;
  }
  .active:after {
    content: "\2212";
  }
  .tabs {
    display: flex;
    margin-bottom: 20px;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f1f1f1;
    border: 1px solid #ccc;
    border-bottom: none;
    margin-right: 5px;
  }
  .tab.active {
    background-color: #fff;
    border-bottom: 1px solid #fff;
  }
  .tab-content {
    display: none;
    padding: 20px;
    border: 1px solid #ccc;
  }
  .tab-content.active {
    display: block;
  }
  #sales-report-viewer {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow-x: auto;
  }
  #sales-report-viewer pre {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  #dashboard {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .dashboard-item {
    background-color: #ecf0f1;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 5px;
    flex-basis: calc(50% - 10px);
  }
  #total-sales-chart, #sales-by-date-chart {
    width: 100%;
    height: 300px;
  }
  .loader {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .order-item {
    background-color: #ecf0f1;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
  }
  .order-details {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background-color: #d6eaf8;
    border-radius: 5px;
  }
  .filtered-total-viewer {
    text-align: center;
    font-family: 'Roboto Mono', monospace;
    font-size: 24px;
    color: #2ecc71;
    margin-bottom: 20px;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .tracked-fields {
    margin-top: 20px;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .tracked-fields h3 {
    margin-top: 0;
    color: #2c3e50;
  }
  #tracked-fields-list {
    list-style-type: none;
    padding: 0;
    columns: 2;
    -webkit-columns: 2;
    -moz-columns: 2;
  }
  #tracked-fields-list li {
    margin-bottom: 5px;
    break-inside: avoid-column;
  }
  #sales-by-category-chart {
    width: 100%;
    height: 300px;
  }
  .two-column-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  .column {
    flex: 1;
    min-width: 300px;
  }
  #total-sales-chart {
    width: 100%;
    height: 250px;
  }
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .loading-content {
    text-align: center;
    background-color: white;
    padding: 2em;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  .progress-bar {
    background-color: #e0e0e0;
    width: 100%;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1em;
  }
  .progress {
    background-color: #3498db;
    height: 100%;
    width: 0;
    transition: width 0.5s ease-in-out;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 10px;
    text-align: left;
    border: 1px solid #ddd;
  }
  th {
    background-color: #f1f1f1;
  }
  #databases-list {
    margin-bottom: 20px;
  }
  .database-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .connection-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
  }
  .connected {
    background-color: #2ecc71;
  }
  .disconnected {
    background-color: #e74c3c;
  }
  #refresh-databases {
    padding: 10px 20px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #refresh-databases:hover {
    background-color: #2980b9;
  }
  .action-button {
    margin: 2px;
    padding: 5px 10px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  .action-button:hover {
    background-color: #2980b9;
  }
  .filter-buttons {
    margin-bottom: 20px;
  }
  .filter-buttons button {
    margin-right: 10px;
    padding: 5px 10px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  .filter-buttons button:hover {
    background-color: #2980b9;
  }
  .discount-total {
    background-color: #ffeb3b;
    color: #000;
    padding: 5px;
    border-radius: 3px;
    font-weight: bold;
  }
  .sum-button {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    background-color: #2ecc71;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  .sum-button:hover {
    background-color: #27ae60;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head><body>
<div id="console" style="background-color: #f0f0f0; border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
</div>
<div id="loading-screen" class="loading-overlay">
  <div class="loading-content">
    <h2>Cargando datos...</h2>
    <p>Mostrando <span id="fetched-orders">0</span> de 782 órdenes (<span id="percentage">0.00</span>)%</p>
    <div class="progress-bar">
      <div id="completion-bar" class="progress"></div>
    </div>
  </div>
</div>
<div class="container">
  <h1>Dashboard de Ventas - dissaladillo.online</h1>
  <button id="sum-button" class="sum-button">SUMAR</button>
  
  <div class="tabs">
    <div class="tab active" data-tab="overview">Vista General</div>
    <div class="tab" data-tab="sales">Ventas</div>
    <div class="tab" data-tab="orders">Pedidos</div>
    <div class="tab" data-tab="products">Productos</div>
    <div class="tab" data-tab="customers">Clientes</div>
    <div class="tab" data-tab="databases">Bases de Datos</div>
  </div>
  
  <div class="filter-buttons">
    <button id="today-filter">Hoy</button>
    <button id="month-filter">MES</button>
  </div>

  <div id="overview" class="tab-content active">
    <div class="numbered-block" data-number="1">
      <button class="collapsible">Advertencia</button>
      <div class="content">
        <div class="warning">
          <strong>Advertencia:</strong> Esta página está realizando una conexión real a la API de WooCommerce de dissaladillo.online con las credenciales proporcionadas. Por favor, asegúrate de que esto es lo que realmente deseas hacer y ten en cuenta las implicaciones de seguridad.
        </div>
      </div>
    </div>

    <div class="two-column-layout">
      <div class="column">
        <div id="sales-report-viewer" class="dashboard-item numbered-block" data-number="2">
          <button class="collapsible">Reporte de Ventas</button>
          <div class="content">
            <pre>Loading...</pre>
          </div>
        </div>

        <div id="filters" class="numbered-block" data-number="3">
          <button class="collapsible">Filtros</button>
          <div class="content">
            <input type="date" id="start-date" placeholder="Fecha inicio">
            <input type="date" id="end-date" placeholder="Fecha fin">
            <button id="apply-filters">Aplicar Filtros</button>
            <button id="reset-filters">Resetear Filtros</button>
          </div>
        </div>

        <div id="filtered-total-viewer" class="filtered-total-viewer numbered-block" data-number="5">
          <button class="collapsible">Total Filtrado</button>
          <div class="content">
            <span id="filtered-total">0.00</span> €
          </div>
        </div>
      </div>

      <div class="column">
        <div class="dashboard-item numbered-block" data-number="4">
          <button class="collapsible">Total de Ventas Completadas</button>
          <div class="content">
            <canvas id="total-sales-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sales" class="tab-content">
    <div class="numbered-block" data-number="10">
      <button class="collapsible">Ventas por Fecha</button>
      <div class="content">
        <canvas id="sales-by-date-chart"></canvas>
      </div>
    </div>
    <div class="numbered-block" data-number="11">
      <button class="collapsible">Resumen de Ventas</button>
      <div class="content">
        <div id="sales-summary"></div>
      </div>
    </div>
    <div class="numbered-block" data-number="14" style="width: 100%;">
      <button class="collapsible">Ventas por Categoría</button>
      <div class="content">
        <canvas id="sales-by-category-chart"></canvas>
      </div>
    </div>
  </div>

  <div id="orders" class="tab-content">
    <div id="orders-filters">
      <input type="date" id="order-start-date" placeholder="Fecha inicio">
      <input type="date" id="order-end-date" placeholder="Fecha fin">
      <input type="text" id="order-id-filter" placeholder="ID del Pedido">
      <input type="text" id="order-status-filter" placeholder="Estado">
      <input type="text" id="order-customer-filter" placeholder="Cliente">
      <input type="text" id="order-cashier-filter" placeholder="Cajero">
      <button id="apply-order-filters">Aplicar Filtros</button>
      <button id="reset-order-filters">Resetear Filtros</button>
    </div>
    <div class="numbered-block" data-number="6">
      <button class="collapsible">Listado de Pedidos</button>
      <div class="content">
        <button id="print-selected-orders" class="action-button">Imprimir Seleccionados</button>
        <button id="generate-loading-sheet" class="action-button">Carga</button>
        <table id="orders-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all-orders"></th>
              <th>ID</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Cajero</th>
              <th>Total</th>
              <th>Fecha</th>
              <th>Reembolso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="orders-table-body">
          </tbody>
        </table>
        <div id="orders-pagination">
          <button id="prev-page">Anterior</button>
          <span id="page-info"></span>
          <button id="next-page">Siguiente</button>
        </div>
      </div>
    </div>

    <div id="tracked-fields" class="tracked-fields numbered-block" data-number="7">
      <button class="collapsible">Campos Rastreables en Órdenes</button>
      <div class="content">
        <h3>Campos rastreados en las órdenes: <span id="tracked-fields-count"></span></h3>
        <ul id="tracked-fields-list"></ul>
      </div>
    </div>

    <div id="tracked-user-fields" class="tracked-fields numbered-block" data-number="15">
      <button class="collapsible">Campos Rastreables en Usuarios</button>
      <div class="content">
        <h3>Campos rastreados en los usuarios: <span id="tracked-user-fields-count"></span></h3>
        <ul id="tracked-user-fields-list"></ul>
      </div>
    </div>

    <div id="tracked-yith-fields" class="tracked-fields numbered-block" data-number="17">
      <button class="collapsible">Campos Rastreables en YITH POS</button>
      <div class="content">
        <h3>Campos rastreados en YITH POS: <span id="tracked-yith-fields-count"></span></h3>
        <ul id="tracked-yith-fields-list"></ul>
      </div>
    </div>

    <button id="update-orders-btn" class="numbered-block" data-number="8" style="margin-bottom: 20px; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Actualizar y Cargar Todas las Órdenes Posibles</button>

    <div id="dashboard">
      <div class="dashboard-item numbered-block" data-number="9">
        <button class="collapsible">Completitud de Datos</button>
        <div class="content">
          <p>Mostrando <span id="fetched-orders"></span> de 782 órdenes (<span id="percentage"></span>%)</p>
          <div style="background-color: #e0e0e0; width: 100%; height: 20px; border-radius: 10px;">
            <div id="completion-bar" style="background-color: #3498db; height: 100%; border-radius: 10px;"></div>
          </div>
        </div>
      </div>

      <div class="dashboard-item numbered-block" data-number="12">
        <button class="collapsible">Resumen de Pedidos</button>
        <div class="content">
          <div id="orders-summary"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="products" class="tab-content">
    <div class="dashboard-item numbered-block" data-number="13">
      <button class="collapsible">Productos más Vendidos</button>
      <div class="content">
        <div id="top-products"></div>
      </div>
    </div>
  </div>

  <div id="customers" class="tab-content">
    <div class="numbered-block" data-number="18">
      <button class="collapsible">Lista de Clientes</button>
      <div class="content">
        <table id="customers-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Total de Pedidos</th>
              <th>Total Gastado</th>
            </tr>
          </thead>
          <tbody id="customers-table-body">
          </tbody>
        </table>
        <div id="customers-pagination">
          <button id="prev-customers-page">Anterior</button>
          <span id="customers-page-info"></span>
          <button id="next-customers-page">Siguiente</button>
        </div>
      </div>
    </div>
  </div>

  <div id="databases" class="tab-content">
    <div class="numbered-block" data-number="16">
      <button class="collapsible">Bases de Datos Disponibles</button>
      <div class="content">
        <div id="databases-list"></div>
        <button id="refresh-databases">Refrescar Bases de Datos</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const consumerKey = 'ck_1983c80f42e03340aef18305419e38be02d82f9c';
    const consumerSecret = 'cs_00efa63f667c041a8b48c465a823767c4c76b91b';
    const baseUrl = 'https://dissaladillo.online/wp-json/wc/v3/';
    
    let allOrders = [];
    let productsData = [];
    let categoriesData = [];
    let totalSalesChart, salesByDateChart, salesByCategoryChart;
    let customersData = [];
    let currentPage = 1;
    let currentCustomersPage = 1;
    const ordersPerPage = 20;
    const customersPerPage = 20;

    function getCashierName(order) {
      const cashierMeta = order.meta_data.find(meta => 
        meta.key === 'yith_pos_cashier' || 
        meta.key === 'pos_cashier' || 
        meta.key === '_yith_pos_cashier'
      );
      if (cashierMeta) {
        const match = cashierMeta.value.match(/(.*?)\s*(?:<(.+)>)?$/);
        if (match) {
          return {
            name: match[1].trim(),
            email: match[2] || 'N/A'
          };
        }
        return {
          name: cashierMeta.value,
          email: 'N/A'
        };
      }
      return {
        name: 'N/A',
        email: 'N/A'
      };
    }

    function displayOrdersTable(orders) {
      const tableBody = document.getElementById('orders-table-body');
      tableBody.innerHTML = '';

      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const displayedOrders = orders.slice(startIndex, endIndex);

      displayedOrders.forEach(order => {
        const row = document.createElement('tr');
        const customerName = `${order.billing.first_name} ${order.billing.last_name}`;
        const cashier = getCashierName(order);
        const isRefunded = order.refunds && order.refunds.length > 0;
        const refundStatus = isRefunded ? '<span style="color: red; font-weight: bold;">Reembolsado</span>' : 'No';
        row.innerHTML = `
          <td><input type="checkbox" class="order-checkbox" data-order-id="${order.id}"></td>
          <td>${order.id}</td>
          <td>${order.status}</td>
          <td>${customerName}</td>
          <td>${cashier.name}<br><small>${cashier.email}</small></td>
          <td>${order.total} ${order.currency}</td>
          <td>${new Date(order.date_created).toLocaleString()}</td>
          <td>${refundStatus}</td>
          <td>
            <button class="action-button" onclick="toggleOrderDetails(${order.id})">Detalles</button>
            <button class="action-button" onclick="calculateOrder(${order.id})">CALCULAR</button>
          </td>
        `;
        if (isRefunded) {
          row.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
        }
        tableBody.appendChild(row);

        const totalCostAndProfit = calculateTotalCost(order);
        const detailsRow = document.createElement('tr');
        detailsRow.innerHTML = `
          <td colspan="9">
            <div id="order-details-${order.id}" class="order-details" style="display: none;">
              <h4>Detalles del Pedido</h4>
              <p><strong>Método de Pago:</strong> ${order.payment_method_title}</p>
              <p><strong>Dirección de Envío:</strong> ${order.shipping.address_1}, ${order.shipping.city}, ${order.shipping.country}</p>
              <p><strong>Total de Coste:</strong> ${totalCostAndProfit.cost} ${order.currency}</p>
              <p><strong>Profit:</strong> ${totalCostAndProfit.profit} ${order.currency}</p>
              <p><strong>Cajero:</strong> ${cashier.name} (${cashier.email})</p>
              <h5>Artículos:</h5>
              <ul>
                ${order.line_items.map(item => {
                  const product = productsData.find(p => p.id === item.product_id);
                  const cogCost = product ? (product.meta_data.find(meta => meta.key === 'yith_cog_cost')?.value || 'N/A') : 'N/A';
                  const profit = cogCost !== 'N/A' ? (parseFloat(item.price) - parseFloat(cogCost)).toFixed(2) : 'N/A';
                  return `<li>${item.name} - Cantidad: ${item.quantity}, Precio: ${item.price} ${order.currency}, YITH COG Cost: ${cogCost}, Profit: ${profit} ${order.currency}</li>`;
                }).join('')}
              </ul>
            </div>
          </td>
        `;
        tableBody.appendChild(detailsRow);
      });

      updatePagination(orders.length);
      
      document.getElementById('select-all-orders').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.order-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
      });
    }

    function displayCustomersTable(customers) {
      const tableBody = document.getElementById('customers-table-body');
      tableBody.innerHTML = '';

      const startIndex = (currentCustomersPage - 1) * customersPerPage;
      const endIndex = startIndex + customersPerPage;
      const displayedCustomers = customers.slice(startIndex, endIndex);

      displayedCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${customer.id}</td>
          <td>${customer.first_name} ${customer.last_name}</td>
          <td>${customer.email}</td>
          <td>${customer.orders_count}</td>
          <td>${parseFloat(customer.total_spent).toFixed(2)} €</td>
        `;
        tableBody.appendChild(row);
      });

      updateCustomersPagination(customers.length);
    }

    function updateCustomersPagination(totalCustomers) {
      const totalPages = Math.ceil(totalCustomers / customersPerPage);
      const pageInfo = document.getElementById('customers-page-info');
      pageInfo.textContent = `Página ${currentCustomersPage} de ${totalPages}`;

      const prevButton = document.getElementById('prev-customers-page');
      const nextButton = document.getElementById('next-customers-page');

      prevButton.disabled = currentCustomersPage === 1;
      nextButton.disabled = currentCustomersPage === totalPages;
    }

    function updateDashboard(filteredOrders, products, categories) {
      displayTotalSalesChart(filteredOrders);
      displaySalesByDateChart(filteredOrders);
      displaySalesSummary(filteredOrders);
      displayTopProducts(filteredOrders, products);
      displaySalesByCategory(filteredOrders, products, categories);
      displayOrdersTable(filteredOrders);
      updateTrackedFields(filteredOrders);
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          activateTab(tabId);
        });
      });
    }

    function activateTab(tabId) {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function updatePagination(totalOrders) {
      const totalPages = Math.ceil(totalOrders / ordersPerPage);
      const pageInfo = document.getElementById('page-info');
      pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;

      const prevButton = document.getElementById('prev-page');
      const nextButton = document.getElementById('next-page');

      prevButton.disabled = currentPage === 1;
      nextButton.disabled = currentPage === totalPages;
    }

    function getDiscountAppliedBy(order) {
      const discountMeta = order.meta_data.find(meta => 
        meta.key === 'discount_applied_by' || 
        meta.key === '_discount_applied_by' ||
        meta.key === 'yith_pos_discount_applied_by'
      );

      if (discountMeta) {
        return discountMeta.value;
      }

      const cashierMeta = order.meta_data.find(meta => 
        meta.key === 'yith_pos_cashier' || 
        meta.key === 'pos_cashier' || 
        meta.key === '_yith_pos_cashier'
      );

      if (cashierMeta) {
        return cashierMeta.value;
      }

      return order.created_by || 'Desconocido';
    }

    function calculateTotalCost(order) {
      let totalCost = 0;
      let totalProfit = 0;
      order.line_items.forEach(item => {
        const product = productsData.find(p => p.id === item.product_id);
        const cogCost = product ? parseFloat(product.meta_data.find(meta => meta.key === 'yith_cog_cost')?.value || 0) : 0;
        const itemCost = cogCost * item.quantity;
        const itemProfit = (parseFloat(item.total) - itemCost);
        totalCost += itemCost;
        totalProfit += itemProfit;
      });
      return { cost: totalCost.toFixed(2), profit: totalProfit.toFixed(2) };
    }

    function calculateOrdersTotals(orders) {
      return orders.reduce((totals, order) => {
        totals.total += parseFloat(order.total);
        totals.quantity += order.line_items.reduce((sum, item) => sum + item.quantity, 0);
        return totals;
      }, { total: 0, quantity: 0 });
    }

    function generatePrintContent(orders) {
      const totals = calculateOrdersTotals(orders);
      let totalProfit = 0;
      
      orders.forEach(order => {
        const { profit } = calculateTotalCost(order);
        totalProfit += parseFloat(profit);
      });
      
      let content = `
        <html>
          <head>
            <title>Pedidos Seleccionados</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .totals { margin-top: 20px; font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Pedidos Seleccionados</h1>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Total</th>
                  <th>Fecha</th>
                  <th>Estado</th>
                  <th>Profit</th>
                </tr>
              </thead>
              <tbody>
      `;

      orders.forEach(order => {
        const customerName = `${order.billing.first_name} ${order.billing.last_name}`;
        const { profit } = calculateTotalCost(order);
        content += `
          <tr>
            <td>${order.id}</td>
            <td>${customerName}</td>
            <td>${order.total} ${order.currency}</td>
            <td>${new Date(order.date_created).toLocaleString()}</td>
            <td>${order.status}</td>
            <td>${profit} ${order.currency}</td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
            <div class="totals">
              <p>Total de Pedidos: ${orders.length}</p>
              <p>Total de Ventas: ${totals.total.toFixed(2)} €</p>
              <p>Total de Artículos: ${totals.quantity}</p>
              <p>Total de Profit: ${totalProfit.toFixed(2)} €</p>
            </div>
          </body>
        </html>
      `;

      return content;
    }

    function generateLoadingSheet(orders) {
      const productTotals = {};

      orders.forEach(order => {
        order.line_items.forEach(item => {
          if (!productTotals[item.name]) {
            productTotals[item.name] = {
              quantity: 0,
              total: 0
            };
          }
          productTotals[item.name].quantity += item.quantity;
          productTotals[item.name].total += parseFloat(item.total);
        });
      });

      let content = `
        <html>
          <head>
            <title>Planilla de Carga</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
            </style>
          </head>
          <body>
            <h1>Planilla de Carga</h1>
            <table>
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
      `;

      Object.entries(productTotals).forEach(([productName, data]) => {
        content += `
          <tr>
            <td>${productName}</td>
            <td>${data.quantity}</td>
            <td>${data.total.toFixed(2)} €</td>
          </tr>
        `;
      });

      content += `
              </tbody>
            </table>
          </body>
        </html>
      `;

      return content;
    }

    function printLoadingSheet() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
      const selectedOrderIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.orderId);
      
      if (selectedOrderIds.length === 0) {
        alert('Por favor, seleccione al menos un pedido para generar la planilla de carga.');
        return;
      }

      const selectedOrders = allOrders.filter(order => selectedOrderIds.includes(order.id.toString()));
      const loadingSheetContent = generateLoadingSheet(selectedOrders);

      const printWindow = window.open('', '_blank');
      printWindow.document.write(loadingSheetContent);
      printWindow.document.close();
      printWindow.print();
    }

    function displayOrdersTable(orders) {
      const tableBody = document.getElementById('orders-table-body');
      tableBody.innerHTML = '';

      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const displayedOrders = orders.slice(startIndex, endIndex);

      displayedOrders.forEach(order => {
        const row = document.createElement('tr');
        const customerName = `${order.billing.first_name} ${order.billing.last_name}`;
        const cashier = getCashierName(order);
        const isRefunded = order.refunds && order.refunds.length > 0;
        const refundStatus = isRefunded ? '<span style="color: red; font-weight: bold;">Reembolsado</span>' : 'No';
        row.innerHTML = `
          <td><input type="checkbox" class="order-checkbox" data-order-id="${order.id}"></td>
          <td>${order.id}</td>
          <td>${order.status}</td>
          <td>${customerName}</td>
          <td>${cashier.name}<br><small>${cashier.email}</small></td>
          <td>${order.total} ${order.currency}</td>
          <td>${new Date(order.date_created).toLocaleString()}</td>
          <td>${refundStatus}</td>
          <td>
            <button class="action-button" onclick="toggleOrderDetails(${order.id})">Detalles</button>
            <button class="action-button" onclick="calculateOrder(${order.id})">CALCULAR</button>
          </td>
        `;
        if (isRefunded) {
          row.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
        }
        tableBody.appendChild(row);

        const totalCostAndProfit = calculateTotalCost(order);
        const detailsRow = document.createElement('tr');
        detailsRow.innerHTML = `
          <td colspan="9">
            <div id="order-details-${order.id}" class="order-details" style="display: none;">
              <h4>Detalles del Pedido</h4>
              <p><strong>Método de Pago:</strong> ${order.payment_method_title}</p>
              <p><strong>Dirección de Envío:</strong> ${order.shipping.address_1}, ${order.shipping.city}, ${order.shipping.country}</p>
              <p><strong>Total de Coste:</strong> ${totalCostAndProfit.cost} ${order.currency}</p>
              <p><strong>Profit:</strong> ${totalCostAndProfit.profit} ${order.currency}</p>
              <p><strong>Cajero:</strong> ${cashier.name} (${cashier.email})</p>
              <h5>Artículos:</h5>
              <ul>
                ${order.line_items.map(item => {
                  const product = productsData.find(p => p.id === item.product_id);
                  const cogCost = product ? (product.meta_data.find(meta => meta.key === 'yith_cog_cost')?.value || 'N/A') : 'N/A';
                  const profit = cogCost !== 'N/A' ? (parseFloat(item.price) - parseFloat(cogCost)).toFixed(2) : 'N/A';
                  return `<li>${item.name} - Cantidad: ${item.quantity}, Precio: ${item.price} ${order.currency}, YITH COG Cost: ${cogCost}, Profit: ${profit} ${order.currency}</li>`;
                }).join('')}
              </ul>
            </div>
          </td>
        `;
        tableBody.appendChild(detailsRow);
      });

      updatePagination(orders.length);
      
      document.getElementById('select-all-orders').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.order-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
      });
    }

    function printSelectedOrders() {
      const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
      const selectedOrderIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.orderId);
      
      if (selectedOrderIds.length === 0) {
        alert('Por favor, seleccione al menos un pedido para imprimir.');
        return;
      }

      const selectedOrders = allOrders.filter(order => selectedOrderIds.includes(order.id.toString()));
      const printContent = generatePrintContent(selectedOrders);

      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    function calculateOrder(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (order) {
        const total = parseFloat(order.total);
        const itemCount = order.line_items.reduce((sum, item) => sum + item.quantity, 0);
        const averageItemPrice = total / itemCount;
        
        alert(`Orden ${orderId}:
        Total: ${total.toFixed(2)} €
        Cantidad de artículos: ${itemCount}
        Precio promedio por artículo: ${averageItemPrice.toFixed(2)} €`);
      } else {
        alert(`No se encontró la orden con ID ${orderId}`);
      }
    }

    function toggleOrderDetails(orderId) {
      const detailsElement = document.getElementById(`order-details-${orderId}`);
      if (detailsElement.style.display === 'none') {
        detailsElement.style.display = 'block';
      } else {
        detailsElement.style.display = 'none';
      }
    }

    function applyOrderFilters() {
      const startDate = document.getElementById('order-start-date').value;
      const endDate = document.getElementById('order-end-date').value;
      const idFilter = document.getElementById('order-id-filter').value.toLowerCase();
      const statusFilter = document.getElementById('order-status-filter').value.toLowerCase();
      const customerFilter = document.getElementById('order-customer-filter').value.toLowerCase();
      const cashierFilter = document.getElementById('order-cashier-filter').value.toLowerCase();

      const filteredOrders = allOrders.filter(order => {
        const orderDate = order.date_created.split('T')[0];
        const customerName = `${order.billing.first_name} ${order.billing.last_name}`.toLowerCase();
        const cashierName = getCashierName(order).name.toLowerCase();

        return (
          (!startDate || orderDate >= startDate) &&
          (!endDate || orderDate <= endDate) &&
          order.id.toString().includes(idFilter) &&
          order.status.toLowerCase().includes(statusFilter) &&
          customerName.includes(customerFilter) &&
          cashierName.includes(cashierFilter)
        );
      });

      currentPage = 1;
      displayOrdersTable(filteredOrders);
    }

    function resetOrderFilters() {
      document.getElementById('order-start-date').value = '';
      document.getElementById('order-end-date').value = '';
      document.getElementById('order-id-filter').value = '';
      document.getElementById('order-status-filter').value = '';
      document.getElementById('order-customer-filter').value = '';
      document.getElementById('order-cashier-filter').value = '';

      currentPage = 1;
      displayOrdersTable(allOrders);
    }

    function applyMonthFilter() {
      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      document.getElementById('order-start-date').value = firstDayOfMonth.toISOString().split('T')[0];
      document.getElementById('order-end-date').value = lastDayOfMonth.toISOString().split('T')[0];
      
      applyOrderFilters();
    }

    function sumFilteredOrders() {
      const visibleOrderRows = document.querySelectorAll('#orders-table-body tr:not([style*="display: none"])');
      let sum = 0;

      visibleOrderRows.forEach(row => {
        const totalCell = row.querySelector('td:nth-child(6)');
        if (totalCell) {
          const total = parseFloat(totalCell.textContent.split(' ')[0]);
          if (!isNaN(total)) {
            sum += total;
          }
        }
      });

      alert(`La suma total de las órdenes filtradas es: ${sum.toFixed(2)} €`);
    }

    function printTodaySalesReport() {
      const today = getTodayDate();
      const todayOrders = allOrders.filter(order => {
        const orderDate = order.date_created.split('T')[0];
        return orderDate === today;
      });

      const totalSales = todayOrders.reduce((total, order) => total + parseFloat(order.total), 0);
      const totalItems = todayOrders.reduce((total, order) => total + order.line_items.reduce((sum, item) => sum + item.quantity, 0), 0);
      let totalProfit = 0;

      todayOrders.forEach(order => {
        const { profit } = calculateTotalCost(order);
        totalProfit += parseFloat(profit);
      });

      const reportContent = `
        <html>
          <head>
            <title>Informe de Ventas del Día</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .total { font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Informe de Ventas del Día: ${today}</h1>
            <table>
              <tr><th>ID</th><th>Cliente</th><th>Total</th><th>Profit</th></tr>
              ${todayOrders.map(order => {
                const { profit } = calculateTotalCost(order);
                return `<tr>
                  <td>${order.id}</td>
                  <td>${order.billing.first_name} ${order.billing.last_name}</td>
                  <td>${parseFloat(order.total).toFixed(2)} €</td>
                  <td>${parseFloat(profit).toFixed(2)} €</td>
                </tr>`;
              }).join('')}
            </table>
            <div class="total">
              <p>Total de Ventas: ${totalSales.toFixed(2)} €</p>
              <p>Total de Artículos Vendidos: ${totalItems}</p>
              <p>Total de Profit: ${totalProfit.toFixed(2)} €</p>
            </div>
          </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportContent);
      printWindow.document.close();
      printWindow.print();
    }

    document.getElementById('sum-button').addEventListener('click', sumFilteredOrders);
    
    document.getElementById('today-filter').addEventListener('click', () => {
      applyTodayFilter();
      printTodaySalesReport();
    });
    document.getElementById('apply-order-filters').addEventListener('click', applyOrderFilters);
    document.getElementById('reset-order-filters').addEventListener('click', resetOrderFilters);
    document.getElementById('print-selected-orders').addEventListener('click', printSelectedOrders);
    document.getElementById('generate-loading-sheet').addEventListener('click', printLoadingSheet);

    async function displayOrdersList(orders) {
      displayOrdersTable(orders);
    }

    function analyzeDatabaseRelationships() {
      const consoleElement = document.getElementById('console');
      consoleElement.innerHTML += "Analyzing database relationships...\n";

      const relationships = [
        "WooCommerce Products (wp_posts.post_type = 'product') -> YITH POS Products (yith_pos_products)",
        "WooCommerce Orders (wp_posts.post_type = 'shop_order') -> YITH POS Orders (yith_pos_orders)",
        "WooCommerce Order Items (wp_wc_order_items) -> YITH POS Order Items (yith_pos_orders)",
        "WooCommerce Users (wp_users) -> YITH POS Customers (yith_pos_customers)",
        "WooCommerce Product Metadata (wp_postmeta) -> YITH POS Product Data",
        "WooCommerce Order Metadata (wp_postmeta) -> YITH POS Order Data",
        "WooCommerce User Metadata (wp_usermeta) -> YITH POS Customer Data"
      ];

      relationships.forEach(relationship => {
        consoleElement.innerHTML += `- ${relationship}\n`;
      });

      consoleElement.innerHTML += "\nKey Relationships:\n";
      consoleElement.innerHTML += "- Products: wp_posts.ID = yith_pos_products.ID\n";
      consoleElement.innerHTML += "- Orders: wp_wc_order_items.order_id = yith_pos_orders.post_id\n";
      consoleElement.innerHTML += "- Customers: wp_users.ID = yith_pos_customers.user_id\n";

      consoleElement.innerHTML += "\nAnalysis complete. These relationships ensure synchronization between WooCommerce and YITH POS for products, orders, and customers.\n";
    }

    async function fetchWooCommerceCustomers(page = 1, perPage = 100) {
      return await fetchWooCommerceData('customers', page, perPage);
    }

    function updateTrackedUserFields(customers) {
      const trackedFields = new Set();
      customers.forEach(customer => {
        Object.keys(customer).forEach(field => trackedFields.add(field));
        if (customer.meta_data) {
          customer.meta_data.forEach(meta => trackedFields.add(meta.key));
        }
      });
      
      const trackedUserFieldsList = document.getElementById('tracked-user-fields-list');
      trackedUserFieldsList.innerHTML = Array.from(trackedFields).map(field => `<li>${field}</li>`).join('');
      document.getElementById('tracked-user-fields-count').textContent = trackedFields.size;
    }

    async function updateTrackedYithFields() {
      try {
        const response = await fetch(`${baseUrl}yith_pos_fields`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const yithFields = await response.json();
        
        const trackedYithFieldsList = document.getElementById('tracked-yith-fields-list');
        if (yithFields && yithFields.length > 0) {
          trackedYithFieldsList.innerHTML = yithFields.map(field => `<li>${field}</li>`).join('');
          document.getElementById('tracked-yith-fields-count').textContent = yithFields.length;
        } else {
          trackedYithFieldsList.innerHTML = '<li>No se encontraron campos YITH POS o no se tiene acceso a esta información.</li>';
          document.getElementById('tracked-yith-fields-count').textContent = '0';
        }
      } catch (error) {
        console.error('Error fetching YITH POS fields:', error);
        document.getElementById('tracked-yith-fields-list').innerHTML = '<li>Error al recuperar la información de los campos YITH POS.</li>';
        document.getElementById('tracked-yith-fields-count').textContent = '0';
      }
    }

    function updateTrackedFields(orders) {
      const trackedFields = new Set();
      orders.forEach(order => {
        Object.keys(order).forEach(field => trackedFields.add(field));
        if (order.meta_data) {
          order.meta_data.forEach(meta => trackedFields.add(meta.key));
        }
      });
      
      const trackedFieldsList = document.getElementById('tracked-fields-list');
      trackedFieldsList.innerHTML = Array.from(trackedFields).map(field => `<li>${field}</li>`).join('');
      document.getElementById('tracked-fields-count').textContent = trackedFields.size;
    }

    async function fetchSalesReport(startDate, endDate) {
      const endpoint = `reports/sales?after=${startDate}T00:00:00&before=${endDate}T23:59:59`;
      return await fetchWooCommerceData(endpoint);
    }

    function displaySalesReport(reportData) {
      const reportViewer = document.createElement('div');
      reportViewer.id = 'sales-report-viewer';
      reportViewer.className = 'dashboard-item numbered-block';
      reportViewer.setAttribute('data-number', '2');
      reportViewer.style.width = '100%';
      reportViewer.innerHTML = `
        <h2>Reporte de Ventas</h2>
        <pre>${JSON.stringify(reportData, null, 2)}</pre>
      `;
      return reportViewer;
    }

    function generateOAuthSignature(method, url, parameters) {
      const signingKey = encodeURIComponent(consumerSecret) + '&';
      const paramString = Object.keys(parameters).sort().map(key => 
        `${encodeURIComponent(key)}=${encodeURIComponent(parameters[key])}`
      ).join('&');
      
      const baseString = `${method}&${encodeURIComponent(url)}&${encodeURIComponent(paramString)}`;
      return CryptoJS.HmacSHA1(baseString, signingKey).toString(CryptoJS.enc.Base64);
    }

    async function fetchWooCommerceData(endpoint, page = 1, perPage = 100) {
      const timestamp = Math.floor(Date.now() / 1000);
      const nonce = CryptoJS.lib.WordArray.random(16).toString();

      const parameters = {
        oauth_consumer_key: consumerKey,
        oauth_nonce: nonce,
        oauth_signature_method: 'HMAC-SHA1',
        oauth_timestamp: timestamp,
        oauth_version: '1.0',
        page: page,
        per_page: perPage
      };

      const signature = generateOAuthSignature('GET', `${baseUrl}${endpoint}`, parameters);
      parameters.oauth_signature = signature;

      const authHeader = 'OAuth ' + Object.keys(parameters).map(key => 
        `${encodeURIComponent(key)}="${encodeURIComponent(parameters[key])}"`
      ).join(', ');

      try {
        const response = await fetch(`${baseUrl}${endpoint}?page=${page}&per_page=${perPage}`, {
          method: 'GET',
          headers: {
            'Authorization': authHeader
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Error:', error);
        return null;
      }
    }

    function displayDataCompleteness(fetchedOrders) {
      const totalOrders = 782;
      const percentage = (fetchedOrders / totalOrders) * 100;
      
      document.getElementById('fetched-orders').innerText = fetchedOrders;
      document.getElementById('percentage').innerText = percentage.toFixed(2);
      document.getElementById('completion-bar').style.width = percentage + '%';

      if (fetchedOrders >= totalOrders) {
        document.getElementById('loading-screen').style.display = 'none';
      }
    }

    async function fetchAllOrders(maxPages = 50) {
      let allOrders = [];
      let page = 1;
      const perPage = 100;

      while (page <= maxPages) {
        const orders = await fetchWooCommerceData('orders', page, perPage);
        if (!orders || orders.length === 0) {
          break;
        }
        allOrders = allOrders.concat(orders);
        if (orders.length < perPage) {
          break;
        }
        page++;
        
        displayDataCompleteness(allOrders.length);
      }

      return allOrders;
    }

    async function updateAndLoadAllOrders() {
      const updateButton = document.getElementById('update-orders-btn');
      updateButton.disabled = true;
      updateButton.textContent = 'Cargando órdenes...';

      allOrders = await fetchAllOrders(50);
      productsData = await fetchWooCommerceData('products', 1, 100); // Fetch more if needed
      categoriesData = await fetchWooCommerceData('products/categories');
      customersData = await fetchWooCommerceCustomers();

      if (allOrders && productsData && categoriesData && customersData) {
        updateDashboard(allOrders, productsData, categoriesData);
        updateTrackedUserFields(customersData);
        await updateTrackedYithFields();
        displayOrdersTable(allOrders); // Refresh the orders table
        displayCustomersTable(customersData); // Refresh the customers table
      } else {
        document.getElementById('dashboard').innerHTML = '<p>Error al recuperar los datos de WooCommerce.</p>';
      }

      updateButton.disabled = false;
      updateButton.textContent = 'Actualizar y Cargar Todas las Órdenes Posibles';
    }

    function resetFilters() {
      document.getElementById('start-date').value = '';
      document.getElementById('end-date').value = '';
      document.getElementById('customer-filter').value = '';
      document.getElementById('pos-cashier-filter').value = '';
      updateDashboard(allOrders, productsData, categoriesData);
    }

    async function fetchAndDisplayDatabases() {
      try {
        const response = await fetch(`${baseUrl}database_list`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const databases = await response.json();
        
        const databasesList = document.getElementById('databases-list');
        if (databases && databases.length > 0) {
          const databasesHtml = databases.map(db => `
            <div class="database-item">
              <span class="connection-status ${db.connected ? 'connected' : 'disconnected'}"></span>
              <span>${db.name}</span>
            </div>
          `).join('');
          databasesList.innerHTML = databasesHtml;
        } else {
          databasesList.innerHTML = '<p>No se encontraron bases de datos o no se tiene acceso a esta información.</p>';
        }
      } catch (error) {
        console.error('Error fetching databases:', error);
        document.getElementById('databases-list').innerHTML = '<p>Error al recuperar la información de las bases de datos.</p>';
      }
    }

    document.getElementById('refresh-databases').addEventListener('click', fetchAndDisplayDatabases);

    async function displayDashboard() {
      const container = document.querySelector('.container');

      try {
        document.getElementById('loading-screen').style.display = 'flex';

        allOrders = await fetchAllOrders(50);
        productsData = await fetchWooCommerceData('products');
        categoriesData = await fetchWooCommerceData('products/categories');
        customersData = await fetchWooCommerceCustomers();

        if (allOrders && productsData && categoriesData && customersData) {
          makeCollapsible();
          analyzeDatabaseRelationships();
          await updateTrackedYithFields();
          displayCustomersTable(customersData); // Populate customers on dashboard load
        } else {
          document.getElementById('dashboard').innerHTML = '<p>Error al recuperar los datos de WooCommerce.</p>';
        }

        document.getElementById('update-orders-btn').addEventListener('click', updateAndLoadAllOrders);
        document.getElementById('apply-filters').addEventListener('click', () => {
          const filteredOrders = applyFilters(allOrders);
          updateDashboard(filteredOrders, productsData, categoriesData);
        });
        document.getElementById('reset-filters').addEventListener('click', resetFilters);
        document.getElementById('today-filter').addEventListener('click', applyTodayFilter);
        document.getElementById('month-filter').addEventListener('click', applyMonthFilter);
        setupTabs();
        await fetchAndDisplayDatabases(); 
      } catch (error) {
        console.error('Error in displayDashboard:', error);
        container.innerHTML = '<p>Error al cargar el dashboard. Por favor, intente nuevamente más tarde.</p>';
      } finally {
        document.getElementById('loading-screen').style.display = 'none';
      }
    }

    function getTodayDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function applyFilters(orders) {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const customerFilter = document.getElementById('customer-filter')?.value.toLowerCase() || '';
      const posCashierFilter = document.getElementById('pos-cashier-filter')?.value.toLowerCase() || '';

      return orders.filter(order => {
        const orderCompletedDate = order.date_completed ? order.date_completed.split('T')[0] : null;
        const customer = `${order.billing.first_name} ${order.billing.last_name}`.toLowerCase();
        const posCashier = order.meta_data.find(meta => meta.key === 'pos_cashier')?.value.toLowerCase() || '';

        return ((!startDate || orderCompletedDate >= startDate) &&
                (!endDate || orderCompletedDate <= endDate) &&
                (!customerFilter || customer.includes(customerFilter)) &&
                (!posCashierFilter || posCashier.includes(posCashierFilter)) &&
                order.status === 'completed' &&
                orderCompletedDate !== null);
      });
    }

    function applyTodayFilter() {
      const today = getTodayDate();
      document.getElementById('start-date').value = today;
      document.getElementById('end-date').value = today;
      const filteredOrders = applyFilters(allOrders);
      updateDashboard(filteredOrders, productsData, categoriesData);
    }

    function displayTotalSalesChart(orders) {
      const completedOrders = orders.filter(order => order.status === 'completed');
      const totalSales = completedOrders.reduce((total, order) => total + parseFloat(order.total), 0);

      const ctx = document.getElementById('total-sales-chart').getContext('2d');
      
      if (totalSalesChart) {
        totalSalesChart.destroy();
      }

      totalSalesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ventas Completadas', 'Otras'],
          datasets: [{
            data: [totalSales, orders.reduce((total, order) => total + parseFloat(order.total), 0) - totalSales],
            backgroundColor: ['#2ecc71', '#e74c3c']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: `Total de Ventas Completadas: ${totalSales.toFixed(2)} €`
            }
          }
        }
      });
    }

    function displaySalesByDateChart(orders) {
      const salesByDate = orders.reduce((acc, order) => {
        const date = order.date_created.split('T')[0];
        if (!acc[date]) {
          acc[date] = 0;
        }
        acc[date] += parseFloat(order.total);
        return acc;
      }, {});

      const dates = Object.keys(salesByDate).sort();
      const sales = dates.map(date => salesByDate[date]);

      const ctx = document.getElementById('sales-by-date-chart').getContext('2d');
      
      if (salesByDateChart) {
        salesByDateChart.destroy();
      }

      salesByDateChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Ventas por Fecha',
            data: sales,
            borderColor: '#3498db',
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Ventas por Fecha'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ventas (€)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Fecha'
              }
            }
          }
        }
      });
    }

    function displaySalesSummary(orders) {
      const totalOrders = 782;
      const fetchedOrders = orders.length;
      const totalSales = orders.reduce((total, order) => total + parseFloat(order.total), 0);
      const averageOrder = totalSales / fetchedOrders;
      const totalItems = orders.reduce((total, order) => total + order.line_items.reduce((sum, item) => sum + item.quantity, 0), 0);

      const summaryHtml = `
        <p><strong>Total de Ventas (muestra):</strong> ${totalSales.toFixed(2)} €</p>
        <p><strong>Número de Pedidos (muestra):</strong> ${fetchedOrders} de ${totalOrders}</p>
        <p><strong>Valor Promedio de Pedido:</strong> ${averageOrder.toFixed(2)} €</p>
        <p><strong>Total de Artículos Vendidos (muestra):</strong> ${totalItems}</p>
      `;

      document.getElementById('sales-summary').innerHTML = summaryHtml;

      const ordersSummaryHtml = `
        <p><strong>Total de Órdenes:</strong> ${totalOrders}</p>
        <p><strong>Órdenes Procesadas (muestra):</strong> ${fetchedOrders}</p>
        <p><strong>Porcentaje de Órdenes Mostradas:</strong> ${((fetchedOrders / totalOrders) * 100).toFixed(2)}%</p>
      `;

      document.getElementById('orders-summary').innerHTML = ordersSummaryHtml;
    }

    function displayTopProducts(orders, products) {
      const productSales = {};
      orders.forEach(order => {
        order.line_items.forEach(item => {
          if (!productSales[item.product_id]) {
            productSales[item.product_id] = { quantity: 0, total: 0 };
          }
          productSales[item.product_id].quantity += item.quantity;
          productSales[item.product_id].total += parseFloat(item.total);
        });
      });

      const topProducts = Object.entries(productSales)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

      const topProductsHtml = topProducts.map(([productId, sales]) => {
        const product = products.find(p => p.id === parseInt(productId));
        return `
          <p><strong>${product ? product.name : 'Producto Desconocido'}:</strong> 
             ${sales.quantity} unidades, ${sales.total.toFixed(2)} €</p>
        `;
      }).join('');

      document.getElementById('top-products').innerHTML = topProductsHtml;
    }

    function displaySalesByCategory(orders, products, categories) {
      const salesByCategory = {};
      categories.forEach(category => {
        salesByCategory[category.id] = { name: category.name, total: 0 };
      });

      orders.forEach(order => {
        order.line_items.forEach(item => {
          const product = products.find(p => p.id === item.product_id);
          if (product && product.categories) {
            product.categories.forEach(category => {
              if (salesByCategory[category.id]) {
                salesByCategory[category.id].total += parseFloat(item.total);
              }
            });
          }
        });
      });

      const categoryData = Object.values(salesByCategory);
      const ctx = document.getElementById('sales-by-category-chart').getContext('2d');

      if (salesByCategoryChart) {
        salesByCategoryChart.destroy();
      }

      salesByCategoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categoryData.map(cat => cat.name),
          datasets: [{
            label: 'Ventas por Categoría',
            data: categoryData.map(cat => cat.total),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Ventas por Categoría de Producto'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ventas (€)'
              }
            }
          }
        }
      });
    }

    function makeCollapsible() {
      var coll = document.getElementsByClassName("collapsible");
      for (var i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
            loadContent(content);
          }
        });
      }
    }

    function loadContent(contentElement) {
      if (contentElement.dataset.loaded) return;
      
      var blockNumber = contentElement.parentElement.getAttribute('data-number');
      switch(blockNumber) {
        case "2":
          fetchAndDisplaySalesReport(contentElement);
          break;
        case "4":
          displayTotalSalesChart(allOrders);
          break;
        case "6":
          displayOrdersTable(allOrders);
          break;
        case "7":
          updateTrackedFields(allOrders);
          break;
        case "10":
          displaySalesByDateChart(allOrders);
          break;
        case "11":
          displaySalesSummary(allOrders);
          break;
        case "13":
          displayTopProducts(allOrders, productsData);
          break;
        case "14":
          displaySalesByCategory(allOrders, productsData, categoriesData);
          break;
        case "15":
          updateTrackedUserFields(customersData);
          break;
        case "18":
          displayCustomersTable(customersData);
          break;
        case "17":
          updateTrackedYithFields();
          break;
      }
      
      contentElement.dataset.loaded = true;
    }

    async function fetchAndDisplaySalesReport(contentElement) {
      const today = getTodayDate();
      const salesReport = await fetchSalesReport(today, today);
      contentElement.innerHTML = `<pre>${JSON.stringify(salesReport, null, 2)}</pre>`;
    }

    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        displayOrdersTable(allOrders);
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      const totalPages = Math.ceil(allOrders.length / ordersPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        displayOrdersTable(allOrders);
      }
    });

    document.getElementById('prev-customers-page').addEventListener('click', () => {
      if (currentCustomersPage > 1) {
        currentCustomersPage--;
        displayCustomersTable(customersData);
      }
    });

    document.getElementById('next-customers-page').addEventListener('click', () => {
      const totalPages = Math.ceil(customersData.length / customersPerPage);
      if (currentCustomersPage < totalPages) {
        currentCustomersPage++;
        displayCustomersTable(customersData);
      }
    });

    (async () => {
      await displayDashboard();
    })();
  </script>
</div>
</body></html>
